author: "ram.matzkovsky@kubiya.ai"
version: 3
type: "conversation"
name: "get AWS cost by region"
steps:
  - type: "input"
    value_type: "enum"
    id: "granularity_chosen"
    prompt: "Granularity: Specify the level of detail for the cost data."
    possible_values:
      - "DAILY"
      - "MONTHLY"
  - type: "condition"
    id: "gran_condition"
    if:
      arg: "${granularity_chosen}"
      is: "equals"
      arg2: "DAILY"
      then:
        - type: "input"
          value_type: "enum"
          id: "time_chosen"
          prompt: "Choose time period."
          possible_values:
            - "Last 14 Days"
            - "Last 7 Days"
            - "Custom"
        - type: "condition"
          id: "custom_condition_daily"
          if:
            arg: "${time_chosen}"
            is: "equals"
            arg2: "Custom"
            then:
              - type: "input"
                value_type: "datetime"
                id: "start_date_daily"
                prompt: "Enter the start date"
              - type: "input"
                value_type: "datetime"
                id: "end_date_daily"
                prompt: "Enter the end date"
              - type: "jq"
                id: "convert_start_date_daily"
                jq: "(.start_date_daily | tonumber) | strftime(\"%Y-%m-%d\")"
              - type: "jq"
                id: "convert_end_date_daily"
                jq: "(.end_date_daily | tonumber) | strftime(\"%Y-%m-%d\")"
              - type: "action"
                id: "cost_action_custom_daily"
                action:
                  name: "ce.GetCostAndUsage"
                  store: "aws"
                  async: false
                  runner: null
                  parameters:
                    Granularity: "${granularity_chosen}"
                    TimePeriod:
                      End: "${convert_end_date_daily}"
                      Start: "${convert_start_date_daily}"
                    GroupBy:
                      - Key: "REGION"
                        Type: "DIMENSION"
                    Metrics:
                      - "UnblendedCost"
              - type: "jq"
                id: "get_custom_regions_daily"
                jq: ".cost_action_custom_daily.ResultsByTime[1].Groups[].Keys[]"
              - type: "input"
                value_type: "enum"
                id: "custom_region_chosen_daily"
                prompt: "Which region would you like to retrieve cost from?"
                possible_values: "${get_custom_regions_daily}"
              - type: "jq"
                id: "daily_cost"
                jq: ".cost_action_custom_daily.ResultsByTime[] | \"\\(.TimePeriod.Start) | \\(.Groups[] | select(.Keys[]==\"${custom_region_chosen_daily}\") | .Metrics.UnblendedCost.Amount | \"$\\(. | tostring)\")\""
              - type: "json_message"
                id: "show_daily_cost_json"
                prompt: "${daily_cost}"
              - type: "exit"
                id: "exit_daily"
            else:
              - type: "jq"
                id: "current_date"
                jq: "now | strftime(\"%Y-%m-%d\")"
              - type: "jq"
                id: "current_date_unix"
                jq: "now"
              - type: "jq"
                id: "end_date_unix"
                jq: ".time_chosen | match(\"Last ([0-9]+) Days\") | .captures[0].string | now - (tonumber * 24 * 60 * 60)"
              - type: "jq"
                id: "end_date_format"
                jq: ".end_date_unix | strftime(\"%Y-%m-%d\")"
              - type: "action"
                id: "cost_action"
                action:
                  name: "ce.GetCostAndUsage"
                  store: "aws"
                  async: false
                  runner: null
                  parameters:
                    Granularity: "${granularity_chosen}"
                    TimePeriod:
                      End: "${current_date}"
                      Start: "${end_date_format}"
                    GroupBy:
                      - Key: "REGION"
                        Type: "DIMENSION"
                    Metrics:
                      - "UnblendedCost"
              - type: "jq"
                id: "get_cost_region"
                jq: ".cost_action.ResultsByTime[0].Groups[].Keys[]"
              - type: "input"
                value_type: "enum"
                id: "region_chosen"
                prompt: "Which region would you like to retrieve cost from?"
                possible_values: "${get_cost_region}"
              - type: "jq"
                id: "region_cost"
                jq: ".cost_action.ResultsByTime[] | \"\\(.TimePeriod.Start) | \\(.Groups[] | select(.Keys[]==\"${region_chosen}\") | .Metrics.UnblendedCost.Amount | \"$\\(. | tostring)\")\""
              - type: "json_message"
                id: "show_cost_json"
                prompt: "${region_cost}"
              - type: "exit"
                id: "exit"
      else:
        - type: "input"
          value_type: "enum"
          id: "time_chosen2"
          prompt: "Choose time period."
          possible_values:
            - "Last 30 Days"
            - "Last 7 Days"
            - "Custom"
        - type: "condition"
          id: "custom_condition"
          if:
            arg: "${time_chosen2}"
            is: "equals"
            arg2: "Custom"
            then:
              - type: "input"
                value_type: "datetime"
                id: "start_date"
                prompt: "Enter the start date"
              - type: "input"
                value_type: "datetime"
                id: "end_date"
                prompt: "Enter the end date"
              - type: "jq"
                id: "convert_start_date"
                jq: "(.start_date | tonumber) | strftime(\"%Y-%m-%d\")"
              - type: "jq"
                id: "convert_end_date"
                jq: "(.end_date | tonumber) | strftime(\"%Y-%m-%d\")"
              - type: "action"
                id: "cost_action_custom"
                action:
                  name: "ce.GetCostAndUsage"
                  store: "aws"
                  async: false
                  runner: null
                  parameters:
                    Granularity: "${granularity_chosen}"
                    TimePeriod:
                      End: "${convert_end_date}"
                      Start: "${convert_start_date}"
                    GroupBy:
                      - Key: "REGION"
                        Type: "DIMENSION"
                    Metrics:
                      - "UnblendedCost"
              - type: "jq"
                id: "get_custom_regions"
                jq: ".cost_action_custom.ResultsByTime[0].Groups[].Keys[]"
              - type: "input"
                value_type: "enum"
                id: "custom_region_chosen"
                prompt: "Which region would you like to retrieve cost from?"
                possible_values: "${get_custom_regions}"
              - type: "jq"
                id: "custom_region_cost"
                jq: ".cost_action_custom.ResultsByTime[] | \"\\(.TimePeriod.Start) - \\(.TimePeriod.End) | \\(.Groups[] | select(.Keys[]==\"eu-west-2\") | .Metrics.UnblendedCost.Amount | \"$\\(. | tostring)\")\""
              - type: "json_message"
                id: "show_custom_cost"
                prompt: "${custom_region_cost}"
              - type: "exit"
                id: "exit3"
            else:
              - type: "jq"
                id: "current_date_monthly"
                jq: "now | strftime(\"%Y-%m-%d\")"
              - type: "jq"
                id: "current_date_unix_monthly"
                jq: "now"
              - type: "jq"
                id: "end_date_unix_monthly"
                jq: ".time_chosen2 | match(\"Last ([0-9]+) Days\") | .captures[0].string | now - (tonumber * 24 * 60 * 60)"
              - type: "jq"
                id: "end_date_format_monthly"
                jq: ".end_date_unix_monthly | strftime(\"%Y-%m-%d\")"
              - type: "action"
                id: "cost_action_monthly"
                action:
                  name: "ce.GetCostAndUsage"
                  store: "aws"
                  async: false
                  runner: null
                  parameters:
                    Granularity: "${granularity_chosen}"
                    TimePeriod:
                      End: "${current_date_monthly}"
                      Start: "${end_date_format_monthly}"
                    GroupBy:
                      - Key: "REGION"
                        Type: "DIMENSION"
                    Metrics:
                      - "UnblendedCost"
              - type: "jq"
                id: "get_cost_region_monthly"
                jq: ".cost_action_monthly.ResultsByTime[0].Groups[].Keys[]"
              - type: "input"
                value_type: "enum"
                id: "region_chosen_monthly"
                prompt: "Which region would you like to retrieve cost from?"
                possible_values: "${get_cost_region_monthly}"
              - type: "jq"
                id: "region_cost_monthly"
                jq: ".cost_action_monthly.ResultsByTime[] | \"\\(.TimePeriod.Start) - \\(.TimePeriod.End) | \\(.Groups[] | select(.Keys[]==\"${region_chosen_monthly}\") | .Metrics.UnblendedCost.Amount | \"$\\(. | tostring)\")\""
              - type: "json_message"
                id: "show_cost_json_monthly"
                prompt: "${region_cost_monthly}"
              - type: "exit"
                id: "exit_monthly"
